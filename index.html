<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Monthly Budget Tracker</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: rgba(0,0,0,0); /* Remove tap highlight on mobile */
        }
        
        html {
            scroll-behavior: smooth; /* Enable smooth scrolling */
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        
        .version {
            position: absolute;
            top: 10px;
            right: 20px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            font-weight: bold;
            z-index: 1; /* Ensure it's above other elements */
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .income-section, .recurring-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .recurring-section {
            background: #f0e8f5;
        }
        
        .budget-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .summary-card {
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .income-card { background: #4CAF50; }
        .spent-card { background: #f44336; }
        .remaining-card { background: #2196F3; }
        
        .category-section {
            margin-bottom: 40px;
        }
        
        hr.section-divider {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0));
            margin: 30px 0;
        }
        
        .add-category {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        input, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            -webkit-appearance: none; /* Removes default styling on iOS */
        }
        
        input[type="number"] {
            -moz-appearance: textfield; /* Remove spinner on Firefox */
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            min-height: 44px; /* Minimum touch target size */
            touch-action: manipulation; /* Prevent delay on touch devices */
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .delete-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #d32f2f;
        }
        
        .edit-btn {
            background: transparent;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        .categories {
            display: grid;
            gap: 15px;
        }
        
        .category {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .budget-progress-container {
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .budget-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .category-name {
            font-weight: bold;
            font-size: 18px;
        }
        
        .category-total {
            font-size: 16px;
            color: #666;
        }
        
        .expense-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .expenses {
            margin-top: 10px;
        }
        
        .expense-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: white;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .share-section, .reset-section, .sync-section {
            margin-top: 30px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 10px;
            border-left: 4px solid #2196F3;
        }
        
        .sync-section {
            background: #e8f5e9;
            border-left: 4px solid #4CAF50;
        }
        
        .reset-section {
            background: #fff0f0;
            border-left: 4px solid #f44336;
            padding: 15px;
            font-size: 0.9em;
        }
        
        .danger-btn {
            background: #f44336;
            color: white;
            font-weight: bold;
        }
        
        .danger-btn:hover {
            background: #d32f2f;
        }
        
        .share-url {
            width: 100%;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 15px;
                margin: 0;
                border-radius: 10px;
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .add-category, .expense-input {
                flex-direction: column;
            }
            
            .category-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .category-header div {
                margin-top: 8px;
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                width: 100%;
            }
            
            .category {
                padding: 12px;
            }
            
            .expense-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 10px;
            }
            
            .expense-item div:last-child {
                margin-top: 5px;
                align-self: flex-end;
            }
            
            input, button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .budget-summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-card {
                padding: 15px 10px;
            }
            
            .delete-btn {
                padding: 8px 12px; /* Larger touch target */
            }
            
            .income-section, .recurring-section {
                padding: 15px;
            }
            
            hr.section-divider {
                margin: 20px 0;
            }
        }
        
        /* Extra small devices */
        @media (max-width: 375px) {
            body {
                padding: 5px;
                font-size: 14px;
            }
            
            .container {
                padding: 10px;
                border-radius: 8px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            h3 {
                font-size: 16px;
            }
            
            h4 {
                font-size: 15px;
            }
            
            .version {
                top: 5px;
                right: 10px;
                font-size: 10px;
            }
            
            input, button {
                font-size: 14px;
            }
            
            .delete-btn {
                padding: 8px 12px;
                min-height: 36px;
            }
            
            .category {
                padding: 10px;
            }
            
            .sync-section, .share-section, .reset-section {
                padding: 15px;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="version">v2.1.0</div>
    <div class="container">
        <h1>Monthly Budget Tracker</h1>
        
        <div class="income-section" id="income-section">
            <h3>Monthly Income</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                <input type="number" id="income-input" placeholder="Enter monthly income" step="0.01">
                <button onclick="setIncome()">Set Income</button>
            </div>
        </div>
        
        <div class="budget-summary">
            <div class="summary-card income-card">
                <h3>Monthly Income <button id="edit-income-btn" class="edit-btn" onclick="showIncomeSection()" style="display: none;">✎</button></h3>
                <div id="total-income">$0.00</div>
            </div>
            <div class="summary-card spent-card">
                <h3>Total Spent</h3>
                <div id="total-spent">$0.00</div>
            </div>
            <div class="summary-card remaining-card">
                <h3>Remaining</h3>
                <div id="remaining-budget">$0.00</div>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <div class="sync-section">
            <h3>Step 1: Get Latest Budget</h3>
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background: #f9f9f9;">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <button onclick="checkConnection()" style="background: #2196F3; flex-grow: 1; padding: 12px;">🔌 Check Connection</button>
                </div>
                <div style="color: #666; margin-bottom: 20px; font-size: 14px;">
                    Make sure you're connected to the shared budget.
                </div>
                <div id="connection-status" style="margin: 10px 0; font-weight: bold;"></div>
                
                <div style="display: flex; align-items: center;">
                    <button onclick="pullFromDatabase()" style="background: #9C27B0; flex-grow: 1; padding: 12px;">📥 Get Latest Budget</button>
                </div>
                <div style="color: #666; margin-bottom: 10px; font-size: 14px;">
                    Always get the latest budget before making changes.
                </div>
                <div id="pull-status" style="margin: 10px 0; font-weight: bold;"></div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-top: 30px; background: #f0f8ff;">
            <h3>Step 2: Update Budget</h3>
            
            <div class="recurring-section" style="background: transparent; padding: 0; margin-top: 20px;">
                <h4>Recurring Expenses</h4>
                <p>Add expenses that automatically deduct from your income each month</p>
                <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <input type="text" id="recurring-desc-input" placeholder="Description (e.g., Rent, Netflix)">
                    <input type="number" id="recurring-amount-input" placeholder="Monthly amount" step="0.01">
                    <button onclick="addRecurringExpense()">Add Recurring Expense</button>
                </div>
                <div id="recurring-expenses" class="expenses" style="margin-top: 15px;"></div>
            </div>
            
            <div class="category-section" style="margin-top: 30px; margin-bottom: 0;">
                <h4>Budget Categories</h4>
                <div class="add-category">
                    <input type="text" id="category-input" placeholder="Category name (e.g., Food, Rent)">
                    <input type="number" id="budget-input" placeholder="Monthly budget" step="0.01">
                    <button onclick="addCategory()">Add Category</button>
                </div>
                <div id="categories" class="categories"></div>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <div class="sync-section" style="background: #e8f5e9;">
            <h3>Step 3: Save Your Changes</h3>
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-top: 15px; background: #f9f9f9;">
                <div style="display: flex; align-items: center;">
                    <button onclick="pushToDatabase()" style="background: #4CAF50; flex-grow: 1; padding: 12px;">📤 Save To Shared Budget</button>
                </div>
                <div style="color: #666; margin-bottom: 10px; font-size: 14px;">
                    After making changes, save them so others can see them.
                </div>
                <div id="push-status" style="margin: 10px 0; font-weight: bold;"></div>
            </div>
        </div>
        

        
        <div style="margin-top: 30px; text-align: right;">
            <button class="danger-btn" onclick="resetApplication()" style="font-size: 14px; padding: 8px 12px;">Clear Budget</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD0p-C0M4faMWthhu7_v-g-8A4z0onrbLw",
            authDomain: "budget-tracker-app-8798f.firebaseapp.com",
            projectId: "budget-tracker-app-8798f",
            storageBucket: "budget-tracker-app-8798f.firebasestorage.app",
            messagingSenderId: "718521107835",
            appId: "1:718521107835:web:1b3df2550e333b20b129de"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let monthlyIncome = 0;
        let categories = {};
        let recurringExpenses = [];
        let currentBudgetId = null;
        let syncEnabled = false;

        function setIncome() {
            const input = document.getElementById('income-input');
            const amount = parseFloat(input.value);
            if (amount && amount > 0) {
                monthlyIncome = amount;
                input.value = '';
                document.getElementById('income-section').style.display = 'none';
                document.getElementById('edit-income-btn').style.display = 'inline';
                updateDisplay();
                saveData();
            }
        }
        
        function showIncomeSection() {
            document.getElementById('income-section').style.display = 'block';
        }

        function addCategory() {
            const nameInput = document.getElementById('category-input');
            const budgetInput = document.getElementById('budget-input');
            const name = nameInput.value.trim();
            const budget = parseFloat(budgetInput.value);
            
            if (name && budget > 0 && !categories[name]) {
                categories[name] = {
                    budget: budget,
                    expenses: []
                };
                nameInput.value = '';
                budgetInput.value = '';
                renderCategories();
                updateDisplay(); // Update display to reflect the new budget allocation
                saveData();
            }
        }

        function deleteCategory(name) {
            if (confirm(`Delete category "${name}" and all its expenses?`)) {
                delete categories[name];
                renderCategories();
                updateDisplay();
                saveData();
            }
        }
        
        function resetExpenses(categoryName) {
            if (confirm(`Reset all expenses in "${categoryName}"?`)) {
                categories[categoryName].expenses = [];
                renderCategories();
                updateDisplay();
                saveData();
            }
        }

        function addExpense(categoryName) {
            const descInput = document.getElementById(`desc-${categoryName}`);
            const amountInput = document.getElementById(`amount-${categoryName}`);
            
            const description = descInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (description && amount && amount > 0) {
                categories[categoryName].expenses.push({
                    description: description,
                    amount: amount,
                    date: new Date().toLocaleDateString()
                });
                
                descInput.value = '';
                amountInput.value = '';
                renderCategories();
                updateDisplay();
                saveData();
            }
        }

        function deleteExpense(categoryName, index) {
            categories[categoryName].expenses.splice(index, 1);
            renderCategories();
            updateDisplay();
            saveData();
        }

        function getCategoryTotal(categoryName) {
            return categories[categoryName].expenses.reduce((sum, expense) => sum + expense.amount, 0);
        }

        function getTotalBudgeted() {
            return Object.keys(categories).reduce((total, categoryName) => {
                return total + categories[categoryName].budget;
            }, 0);
        }
        
        function getTotalOverspent() {
            return Object.keys(categories).reduce((total, categoryName) => {
                const spent = getCategoryTotal(categoryName);
                const budget = categories[categoryName].budget;
                // Only count overspending against the remaining budget
                return total + Math.max(0, spent - budget);
            }, 0);
        }

        function getTotalRecurring() {
            return recurringExpenses.reduce((sum, expense) => sum + expense.amount, 0);
        }

        function updateDisplay() {
            const totalRecurring = getTotalRecurring();
            const totalBudgeted = getTotalBudgeted();
            const totalOverspent = getTotalOverspent();
            
            // Calculate remaining by subtracting recurring expenses and budgeted amounts
            // Then subtract any overspending from categories
            const remaining = monthlyIncome - totalRecurring - totalBudgeted - totalOverspent;
            
            // For display purposes, show the total spent in categories
            const totalCategorySpent = Object.keys(categories).reduce((total, categoryName) => {
                return total + getCategoryTotal(categoryName);
            }, 0);
            
            document.getElementById('total-income').textContent = `$${monthlyIncome.toFixed(2)}`;
            document.getElementById('total-spent').textContent = `$${totalCategorySpent.toFixed(2)}`;
            document.getElementById('remaining-budget').textContent = `$${remaining.toFixed(2)}`;
            
            // Change color based on remaining budget
            const remainingCard = document.querySelector('.remaining-card');
            if (remaining < 0) {
                remainingCard.style.background = '#f44336';
            } else if (remaining < monthlyIncome * 0.1) {
                remainingCard.style.background = '#ff9800';
            } else {
                remainingCard.style.background = '#2196F3';
            }
        }

        function renderCategories() {
            const container = document.getElementById('categories');
            container.innerHTML = '';
            
            Object.keys(categories).forEach(categoryName => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                const budget = categories[categoryName].budget;
                const spent = getCategoryTotal(categoryName);
                const remaining = budget - spent;
                const remainingColor = remaining < 0 ? '#f44336' : remaining < budget * 0.1 ? '#ff9800' : '#4CAF50';
                
                // Calculate percentage spent for progress bar
                const percentSpent = budget > 0 ? (spent / budget) * 100 : 0;
                let progressColor;
                
                if (percentSpent <= 50) {
                    progressColor = '#4CAF50'; // Green
                } else if (percentSpent <= 85) {
                    progressColor = '#ff9800'; // Yellow/Orange
                } else {
                    progressColor = '#f44336'; // Red
                }
                
                categoryDiv.innerHTML = `
                    <div class="category-header">
                        <span class="category-name">${categoryName}</span>
                        <div>
                            <span style="color: #666;">Budget: $${budget.toFixed(2)} | Spent: $${spent.toFixed(2)}</span>
                            <button class="delete-btn" onclick="resetExpenses('${categoryName}')" style="margin-left: 10px; margin-right: 5px; background: #ff9800;">Reset</button>
                            <button class="delete-btn" onclick="deleteCategory('${categoryName}')">Delete</button>
                        </div>
                    </div>
                    <div class="budget-progress-container">
                        <div class="budget-progress-bar" style="width: ${Math.min(percentSpent, 100)}%; background-color: ${progressColor};"></div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; margin-top: 5px;">
                        <span style="color: ${remainingColor}; font-weight: bold;">Remaining: $${remaining.toFixed(2)}</span>
                    </div>
                    <div class="expense-input">
                        <input type="text" id="desc-${categoryName}" placeholder="Daily expense description">
                        <input type="number" id="amount-${categoryName}" placeholder="Amount" step="0.01">
                        <button onclick="addExpense('${categoryName}')">Add Expense</button>
                    </div>
                    <div class="expenses">
                        ${categories[categoryName].expenses.map((expense, index) => `
                            <div class="expense-item">
                                <div>
                                    <strong>${expense.description}</strong>
                                    <small style="color: #666; margin-left: 10px;">${expense.date}</small>
                                </div>
                                <div>
                                    <span>$${expense.amount.toFixed(2)}</span>
                                    <button class="delete-btn" onclick="deleteExpense('${categoryName}', ${index})" style="margin-left: 10px;">×</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categoryDiv);
            });
        }

        function addRecurringExpense() {
            const descInput = document.getElementById('recurring-desc-input');
            const amountInput = document.getElementById('recurring-amount-input');
            
            const description = descInput.value.trim();
            const amount = parseFloat(amountInput.value);
            
            if (description && amount && amount > 0) {
                recurringExpenses.push({
                    description: description,
                    amount: amount
                });
                
                descInput.value = '';
                amountInput.value = '';
                renderRecurringExpenses();
                updateDisplay();
                saveData();
            }
        }

        function deleteRecurringExpense(index) {
            recurringExpenses.splice(index, 1);
            renderRecurringExpenses();
            updateDisplay();
            saveData();
        }

        function renderRecurringExpenses() {
            const container = document.getElementById('recurring-expenses');
            container.innerHTML = '';
            
            recurringExpenses.forEach((expense, index) => {
                const expenseDiv = document.createElement('div');
                expenseDiv.className = 'expense-item';
                
                expenseDiv.innerHTML = `
                    <div>
                        <strong>${expense.description}</strong>
                    </div>
                    <div>
                        <span>$${expense.amount.toFixed(2)}</span>
                        <button class="delete-btn" onclick="deleteRecurringExpense(${index})" style="margin-left: 10px;">×</button>
                    </div>
                `;
                
                container.appendChild(expenseDiv);
            });
        }

        function saveData() {
            const data = {
                monthlyIncome: monthlyIncome,
                categories: categories,
                recurringExpenses: recurringExpenses
            };
            localStorage.setItem('budgetData', JSON.stringify(data));
            
            // If sync is enabled, save to Firebase
            if (syncEnabled && currentBudgetId) {
                saveBudgetToFirebase();
            }
        }
        
        function saveBudgetToFirebase() {
            if (!currentBudgetId) return;
            
            const data = {
                monthlyIncome: monthlyIncome,
                categories: categories,
                recurringExpenses: recurringExpenses,
                lastUpdated: new Date().toISOString()
            };
            
            db.collection('budgets').doc(currentBudgetId).set(data)
                .then(() => {
                    document.getElementById('sync-status').textContent = 'Budget synced successfully!';
                    document.getElementById('sync-status').style.color = '#4CAF50';
                    setTimeout(() => {
                        document.getElementById('sync-status').textContent = '';
                    }, 3000);
                })
                .catch(error => {
                    console.error('Error saving budget to Firebase:', error);
                    document.getElementById('sync-status').textContent = 'Sync failed: ' + error.message;
                    document.getElementById('sync-status').style.color = '#f44336';
                });
        }

        function loadData() {
            const saved = localStorage.getItem('budgetData');
            if (saved) {
                const data = JSON.parse(saved);
                monthlyIncome = data.monthlyIncome || 0;
                categories = data.categories || {};
                recurringExpenses = data.recurringExpenses || [];
                
                // Convert old format to new format
                Object.keys(categories).forEach(name => {
                    if (Array.isArray(categories[name])) {
                        categories[name] = {
                            budget: 0,
                            expenses: categories[name]
                        };
                    }
                });
                
                // Hide income section if income is already set
                if (monthlyIncome > 0) {
                    document.getElementById('income-section').style.display = 'none';
                    document.getElementById('edit-income-btn').style.display = 'inline';
                }
                
                renderCategories();
                renderRecurringExpenses();
                updateDisplay();
            }
        }

        function checkConnection() {
            const statusElement = document.getElementById('connection-status');
            statusElement.textContent = 'Checking connection...';
            statusElement.style.color = '#2196F3';
            
            db.collection('budgets').limit(1).get()
                .then(() => {
                    statusElement.textContent = '✓ Connected to Firebase: ' + firebaseConfig.projectId;
                    statusElement.style.color = '#4CAF50';
                })
                .catch(error => {
                    statusElement.textContent = '✗ Connection failed: ' + error.message;
                    statusElement.style.color = '#f44336';
                });
        }
        
        function estimateDataSize(data) {
            // Convert data to JSON string and measure its size in bytes
            const jsonString = JSON.stringify(data);
            const bytes = new TextEncoder().encode(jsonString).length;
            
            // Convert to KB or MB for display
            if (bytes < 1024) {
                return bytes + ' bytes';
            } else if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(2) + ' KB';
            } else {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            }
        }
        
        function pushToDatabase() {
            const budgetId = 'shared-budget'; // Fixed ID for simplicity
            
            const data = {
                monthlyIncome: monthlyIncome,
                categories: categories,
                recurringExpenses: recurringExpenses,
                lastUpdated: new Date().toISOString()
            };
            
            const dataSize = estimateDataSize(data);
            const statusElement = document.getElementById('push-status');
            statusElement.textContent = 'Pushing to database...';
            statusElement.style.color = '#2196F3';
            
            db.collection('budgets').doc(budgetId).set(data)
                .then(() => {
                    statusElement.textContent = `Budget pushed to database successfully! (${dataSize} of 1GB used)`;
                    statusElement.style.color = '#4CAF50';
                    currentBudgetId = budgetId;
                    syncEnabled = true;
                })
                .catch(error => {
                    statusElement.textContent = 'Push failed: ' + error.message;
                    statusElement.style.color = '#f44336';
                });
        }
        
        function pullFromDatabase() {
            const budgetId = 'shared-budget'; // Fixed ID for simplicity
            
            const statusElement = document.getElementById('pull-status');
            statusElement.textContent = 'Pulling from database...';
            statusElement.style.color = '#2196F3';
            
            db.collection('budgets').doc(budgetId).get()
                .then(doc => {
                    if (doc.exists) {
                        const budgetData = doc.data();
                        const dataSize = estimateDataSize(budgetData);
                        
                        // Load the budget data
                        monthlyIncome = budgetData.monthlyIncome || 0;
                        categories = budgetData.categories || {};
                        recurringExpenses = budgetData.recurringExpenses || [];
                        
                        // Update UI
                        if (monthlyIncome > 0) {
                            document.getElementById('income-section').style.display = 'none';
                            document.getElementById('edit-income-btn').style.display = 'inline';
                        }
                        
                        renderCategories();
                        renderRecurringExpenses();
                        updateDisplay();
                        
                        // Save to local storage as backup
                        localStorage.setItem('budgetData', JSON.stringify({
                            monthlyIncome, categories, recurringExpenses
                        }));
                        
                        statusElement.textContent = `Budget pulled from database successfully! (${dataSize} of 1GB used)`;
                        statusElement.style.color = '#4CAF50';
                        currentBudgetId = budgetId;
                        syncEnabled = true;
                    } else {
                        statusElement.textContent = 'No budget found in database. Push your budget first.';
                        statusElement.style.color = '#ff9800';
                    }
                })
                .catch(error => {
                    statusElement.textContent = 'Pull failed: ' + error.message;
                    statusElement.style.color = '#f44336';
                });
        }
        
        function generateShareLink() {
            if (!currentBudgetId) {
                alert('Please create or load a shared budget first');
                return;
            }
            
            const syncSettings = localStorage.getItem('budgetSync');
            if (syncSettings) {
                try {
                    const { id, password } = JSON.parse(syncSettings);
                    const rawPassword = atob(password); // Decode the password
                    
                    // Create a shareable link with budget ID and password
                    const shareLink = `${window.location.origin}${window.location.pathname}?sync=${encodeURIComponent(id)}&key=${encodeURIComponent(rawPassword)}`;
                    
                    const shareLinkElement = document.getElementById('share-link');
                    shareLinkElement.value = shareLink;
                    document.getElementById('share-link-container').style.display = 'block';
                    
                    // Select the link for easy copying
                    shareLinkElement.select();
                    document.execCommand('copy');
                    
                    document.getElementById('sync-status').textContent = 'Share link copied to clipboard!';
                    document.getElementById('sync-status').style.color = '#4CAF50';
                } catch (error) {
                    console.error('Error generating share link:', error);
                }
            }
        }
        
        function createSharedBudget() {
            const budgetId = document.getElementById('budget-id').value.trim();
            const password = document.getElementById('budget-password').value.trim();
            
            if (!budgetId || !password) {
                alert('Please enter both a budget ID and password');
                return;
            }
            
            // Hash the password (in a real app, use a better hashing method)
            const hashedPassword = btoa(password);
            
            // Add owner information
            const ownerEmail = prompt('Enter your email (for ownership verification):', '');
            if (!ownerEmail) return;
            
            // Check if budget already exists
            db.collection('budgets').doc(budgetId).get()
                .then(doc => {
                    if (doc.exists) {
                        // Budget exists, check password and ownership
                        const budgetData = doc.data();
                        if (budgetData.password === hashedPassword) {
                            // Check ownership
                            if (budgetData.ownerEmail && budgetData.ownerEmail !== ownerEmail) {
                                const isConfirmed = confirm(`This budget belongs to ${budgetData.ownerEmail}. Are you authorized to access it?`);
                                if (!isConfirmed) return;
                            }
                            // Password matches, load the budget
                            loadBudgetFromFirebase(budgetId, hashedPassword);
                        } else {
                            alert('A budget with this ID already exists with a different password');
                        }
                    } else {
                        // Budget doesn't exist, create it
                        const data = {
                            monthlyIncome: monthlyIncome,
                            categories: categories,
                            recurringExpenses: recurringExpenses,
                            password: hashedPassword,
                            ownerEmail: ownerEmail,
                            created: new Date().toISOString(),
                            lastUpdated: new Date().toISOString()
                        };
                        
                        db.collection('budgets').doc(budgetId).set(data)
                            .then(() => {
                                currentBudgetId = budgetId;
                                syncEnabled = true;
                                document.getElementById('sync-status').textContent = 'Shared budget created successfully!';
                                document.getElementById('sync-status').style.color = '#4CAF50';
                                localStorage.setItem('budgetSync', JSON.stringify({ id: budgetId, password: hashedPassword }));
                                
                                // Set up real-time listener
                                setupRealtimeSync(budgetId);
                            })
                            .catch(error => {
                                console.error('Error creating budget:', error);
                                document.getElementById('sync-status').textContent = 'Failed to create budget: ' + error.message;
                                document.getElementById('sync-status').style.color = '#f44336';
                            });
                    }
                })
                .catch(error => {
                    console.error('Error checking budget:', error);
                    document.getElementById('sync-status').textContent = 'Error: ' + error.message;
                    document.getElementById('sync-status').style.color = '#f44336';
                });
        }
        
        function loadSharedBudget() {
            const budgetId = document.getElementById('budget-id').value.trim();
            const password = document.getElementById('budget-password').value.trim();
            
            if (!budgetId || !password) {
                alert('Please enter both a budget ID and password');
                return;
            }
            
            // Hash the password
            const hashedPassword = btoa(password);
            
            loadBudgetFromFirebase(budgetId, hashedPassword);
        }
        
        function loadBudgetFromFirebase(budgetId, hashedPassword) {
            db.collection('budgets').doc(budgetId).get()
                .then(doc => {
                    if (doc.exists) {
                        const budgetData = doc.data();
                        
                        // Verify password
                        if (budgetData.password === hashedPassword) {
                            // Check ownership
                            if (budgetData.ownerEmail) {
                                const userEmail = prompt(`This budget belongs to ${budgetData.ownerEmail}. Enter your email to verify access:`, '');
                                if (!userEmail) return;
                                
                                if (userEmail !== budgetData.ownerEmail) {
                                    const isConfirmed = confirm(`Your email doesn't match the owner's email. Are you authorized to access this budget?`);
                                    if (!isConfirmed) return;
                                }
                            }
                            
                            // Password matches, load the budget
                            monthlyIncome = budgetData.monthlyIncome || 0;
                            categories = budgetData.categories || {};
                            recurringExpenses = budgetData.recurringExpenses || [];
                            
                            // Update UI
                            if (monthlyIncome > 0) {
                                document.getElementById('income-section').style.display = 'none';
                                document.getElementById('edit-income-btn').style.display = 'inline';
                            }
                            
                            renderCategories();
                            renderRecurringExpenses();
                            updateDisplay();
                            
                            // Save to local storage as backup
                            localStorage.setItem('budgetData', JSON.stringify({
                                monthlyIncome, categories, recurringExpenses
                            }));
                            
                            // Enable sync
                            currentBudgetId = budgetId;
                            syncEnabled = true;
                            localStorage.setItem('budgetSync', JSON.stringify({ id: budgetId, password: hashedPassword }));
                            
                            document.getElementById('sync-status').textContent = 'Budget loaded successfully!';
                            document.getElementById('sync-status').style.color = '#4CAF50';
                            
                            // Set up real-time listener
                            setupRealtimeSync(budgetId);
                        } else {
                            alert('Incorrect password for this budget');
                            document.getElementById('sync-status').textContent = 'Access denied: Incorrect password';
                            document.getElementById('sync-status').style.color = '#f44336';
                        }
                    } else {
                        alert('No budget found with this ID');
                        document.getElementById('sync-status').textContent = 'Budget not found';
                        document.getElementById('sync-status').style.color = '#f44336';
                    }
                })
                .catch(error => {
                    console.error('Error loading budget:', error);
                    document.getElementById('sync-status').textContent = 'Error: ' + error.message;
                    document.getElementById('sync-status').style.color = '#f44336';
                });
        }
        
        function setupRealtimeSync(budgetId) {
            // Set up real-time listener for changes
            db.collection('budgets').doc(budgetId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const budgetData = doc.data();
                        const localLastUpdate = localStorage.getItem('lastUpdate');
                        
                        // Only update if the data is newer than our last update
                        if (!localLastUpdate || budgetData.lastUpdated > localLastUpdate) {
                            // Don't update if we just saved the data ourselves
                            if (budgetData.lastUpdated !== localStorage.getItem('lastUpdate')) {
                                monthlyIncome = budgetData.monthlyIncome || 0;
                                categories = budgetData.categories || {};
                                recurringExpenses = budgetData.recurringExpenses || [];
                                
                                // Update UI
                                if (monthlyIncome > 0) {
                                    document.getElementById('income-section').style.display = 'none';
                                    document.getElementById('edit-income-btn').style.display = 'inline';
                                }
                                
                                renderCategories();
                                renderRecurringExpenses();
                                updateDisplay();
                                
                                document.getElementById('sync-status').textContent = 'Budget updated from cloud!';
                                document.getElementById('sync-status').style.color = '#2196F3';
                                setTimeout(() => {
                                    document.getElementById('sync-status').textContent = '';
                                }, 3000);
                            }
                        }
                    }
                }, error => {
                    console.error('Error in real-time sync:', error);
                });
        }
        
        // Check for existing sync settings
        function checkExistingSync() {
            const syncSettings = localStorage.getItem('budgetSync');
            if (syncSettings) {
                try {
                    const { id, password } = JSON.parse(syncSettings);
                    if (id && password) {
                        document.getElementById('budget-id').value = id;
                        document.getElementById('budget-password').value = atob(password);
                        document.getElementById('sync-status').textContent = 'Reconnecting to shared budget...';
                        document.getElementById('sync-status').style.color = '#2196F3';
                        loadBudgetFromFirebase(id, password);
                    }
                } catch (error) {
                    console.error('Error parsing sync settings:', error);
                }
            }
        }
        
        // Load data when page loads
        window.onload = function() {
            loadData();
            
            // Check connection status
            checkConnection();
        };

        // No longer needed - URL sharing functionality removed

        // Allow Enter key to submit forms
        document.getElementById('income-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') setIncome();
        });

        document.getElementById('category-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addCategory();
        });

        document.getElementById('recurring-desc-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addRecurringExpense();
        });
        
        document.getElementById('recurring-amount-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addRecurringExpense();
        });
        
        function resetApplication() {
            if (confirm('WARNING: This will delete ALL your budget data! Are you sure you want to reset the application?')) {
                if (confirm('FINAL WARNING: All data will be permanently lost. Continue?')) {
                    localStorage.removeItem('budgetData');
                    
                    // Reset local variables
                    monthlyIncome = 0;
                    categories = {};
                    recurringExpenses = [];
                    currentBudgetId = null;
                    syncEnabled = false;
                    
                    alert('Application reset successful. The page will now reload.');
                    window.location.reload();
                }
            }
        }
    </script>
</body>
</html>
